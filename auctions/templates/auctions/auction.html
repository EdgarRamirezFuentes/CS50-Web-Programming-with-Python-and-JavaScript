{% extends "auctions/layout.html" %}
{% load mathfilters %}

{% block title %} {{ auction.item_name }} {% endblock %}

{% block body %}
<div class="container">
    <div class="row">
        <h1 class="text-center"> {{ auction.item_name }} </h1>

        {% if ended %}
        <h2 class="text-center text-danger">This auction has ended</h2>
        {% else %}
        <div class="d-flex flex-column my-3">
            <span>Days Left: {{ days }}d</span>
            <span>Auction ends at: {{ auction.end_time }}</span>
        </div>
        {% endif %}

        {% if auction.image %}
        <div class="my-3">
            <h2>Image:</h2>
            <div class="d-flex justify-content-center">
                <img class="my-2 w-50" src="{{ auction.image.url }}">
            </div>
        </div>
        {% endif %}

        <div class="d-flex">
            {% if request.user.is_authenticated %}
            <form method="POST" action="{% url 'watch_auction' auction.id %}" class="form-inline">
                {% csrf_token%}
                {% if auction in request.user.watchlist.all %}
                <input class="btn btn-danger btn-sm" type="submit" value="Remove from Watchlist" />
                {% else %}
                <input class="btn btn-secondary btn-sm" type="submit" value="Add to Watchlist" />
                {% endif %}
            </form>
            {% endif %}

            {% if request.user == auction.user and not ended %}
            <form method="POST" action="{% url 'close_auction' auction.id %}">
                {% csrf_token %}
                <input class="btn btn-danger btn-sm mx-3" type="submit" value="End auction" />
            </form>
            {% endif %}
        </div>

        <div class="my-3">
            <h3>Details</h3>
            <span>Listed by <b>{{ auction.user }}</b></span>
            <br>
            <span>
                Category:
                {% if auction.category %}
                <a href="{% url 'category' auction.category.name %}">
                    {{ auction.category.name}}
                </a>
                {% else %}
                No category
                {% endif %}
            </span>
        </div>

        <div class="my-3">
            <h3>Description</h3>
            <p class="text-justify my-2 w-75"> {{ auction.item_description }} </p>
        </div>

        <div>
            <h3>Bids Information</h3>
            {% if request.user == auction.user %}
            <h5>Number of bids: {{ auction.bids.all.count }}</h5>
            {% endif %}
            <h5>Starting bid: ${{ auction.start_bid }}</h5>
            <h5>
                Highest bid: $
                {% if auction.bids.all.count > 0 %}
                $ {{ auction.bids.first.amount }}
                {% else %}
                $ {{ auction.start_bid }}
                {% endif %}
            </h5>
            <h5>
                Highest bidder:
                {% if auction.bids.all.count > 0 %}
                {{ auction.bids.first.user }}
                {% else %}
                No bids yet
                {% endif %}
            </h5>
        </div>


        <div class="my-3">
            {% if request.user.is_authenticated and not ended and request.user != auction.user %}
            <h3>Place Bid</h3>
            <form method="POST" action="{% url 'auction_bid' auction.id %}" class="form-inline w-25">
                {% csrf_token %}
                <div class="form-group">
                    {{ bid_form.amount }}
                    <input class="btn btn-primary" type="submit" value="Place Bid" />
                </div>
            </form>
            {% endif %}
        </div>

        <div id="comments-section" class="bg-light">
            <h3 class="py-4">Comments</h3>
            <div class="py-2">
                {% for comment in auction.comments.all %}
                <div class="card p-1 m-2 col-12 w-50">
                    <div class="card-body">
                        <h5 class="card-title">{{ comment.user }}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">{{ comment.time }}</h6>
                        {{ comment.message }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if request.user.is_authenticated and not ended %}
            <h3>Post a comment</h3>
            <form method="POST" action="{% url 'post_comment' auction.id %}">
                {% csrf_token %}
                <div class="form-group w-75">
                    {{ comment_form.message }}
                    <div>
                        <input class="btn btn-primary p-2 m-2" type="submit" value="Post a comment" />
                    </div>
                </div>
            </form>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}